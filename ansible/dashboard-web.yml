---
- name: Provisioning Dashboard
  hosts: dashboard-web
  serial: "{{ datagov_serial | default(1) }}"
  roles:
    - { role: software/common/tls, tags: [provision, tls] }
    - { role: software/common/php-common, tags: [provision] }
    - { role: geerlingguy.git, tags: [provision] }
    - { role: geerlingguy.php-versions, tags: [php, provision] }
    - { role: geerlingguy.php, tags: [php, provision] }
    - { role: geerlingguy.php-mysql, tags: [php, php-mysql, provision] }
    - { role: geerlingguy.php-memcached, tags: [php, php-memcached, provision] }
    - { role: software/common/php-fixes, tags: [php, provision] }
    - { role: geerlingguy.composer, tags: [php, provision] }


- name: Deploy nginx
  hosts: dashboard-web
  roles:
    - role: nginxinc.nginx
      vars:
        nginx_branch: stable
        nginx_state: latest
      tags: [nginx, provision]

- name: Config nginx
  hosts: dashboard-web
  roles:
    - role: nginxinc.nginx_config
      vars:
        nginx_config_cleanup_files:
          - /etc/nginx/conf.d/default.conf

        nginx_config_main_template_enable: true
        nginx_config_main_template:
          template_file: nginx.conf.j2
          conf_file_name: nginx.conf
          conf_file_location: /etc/nginx/
          worker_processes: auto
          pid: /var/run/nginx.pid
          error_log:
            location: /var/log/nginx/error.log
            level: notice
          worker_connections: 1024
          http_enable: true
          http_settings:
            default_type: application/octet-stream
            include: /etc/nginx/mime.types
            access_log_format:
              - name: main
                format: |-
                  '$remote_addr - $remote_user [$time_local] "$request" '
                                      '$status $body_bytes_sent "$http_referer" '
                                      '"$http_user_agent" "$http_x_forwarded_for"'
            access_log_location:
              - name: main
                location: /var/log/nginx/access.log
            sendfile: on
            keepalive_timeout: 65
            server_tokens: "off"
      tags: [nginx, provision]

- name: Deploying Dashboard
  hosts: dashboard-web
  serial: "{{ datagov_serial | default(1) }}"
  roles:
    - { role: gsa.datagov-deploy-dashboard, tags: [deploy, provision] }
  # Host-level smoke tests
  tasks:
    - name: flush handlers
      meta: flush_handlers

    - name: assert app is up
      uri:
        url: https://{{ ansible_fqdn }}/offices/qa
        follow_redirects: none
        status_code: 200
        # TODO enable cert validation. Staging and production hosts have GSA
        # signed certs which should be valid.
        # https://github.com/gsa/data.gov/issues/900
        validate_certs: false
      register: result
      retries: 3
      delay: 10
      until: not result.failed

- name: Service-level smoke tests for dashboard
  hosts: dashboard-web
  tags:
    - deploy
    - provision
    - smoke
  tasks:
    - name: flush handlers
      meta: flush_handlers

    - name: assert app is up
      uri:
        url: "{{ dashboard_service_url }}/offices/qa"
        follow_redirects: none
        status_code: 200
        # TODO enable cert validation. Staging and production hosts have GSA
        # signed certs which should be valid.
        # https://github.com/gsa/data.gov/issues/900
        validate_certs: false
      run_once: true
      delegate_to: localhost
      become: false
      register: result
      retries: 3
      delay: 20
      until: not result.failed

- name: Configure Logrotate
  hosts: dashboard-web
  vars:
    dashboard_logrotate_options:
      - compress
      - daily
      - delaycompress
      - mail {{ datagov_team_email }}
      - mailfirst
      - missingok
      - rotate 60
  roles:
    - role: nickhammond.logrotate
      logrotate_scripts:
        # We keep these separate so that we get two distinct emails
        - name: dashboard-cfo-act-download
          paths:
            - /var/log/dashboard/campaign-status-download.log
          options: "{{ dashboard_logrotate_options }}"
        - name: dashboard-cfo-act-full-scan
          paths:
            - /var/log/dashboard/campaign-status-full-scan.log
          options: "{{ dashboard_logrotate_options }}"

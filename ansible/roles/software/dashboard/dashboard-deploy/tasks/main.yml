--- # Dashboard repo deployment & composer install

- name: Remove old rollback code
  file: path="{{ project_source_rollback_path }}" state=absent

- name: Check whether "{{ project_source_new_code_path }}" exists
  stat: path="{{ project_source_new_code_path }}"
  register: p

- name: Create rollback code
  command: cp -r "{{ project_source_new_code_path }}" "{{ project_source_rollback_path }}"
  when: p.stat.isdir is defined and p.stat.isdir

- name: Symlink current dir with rollback code
  file:
    src: "{{ project_source_rollback_path }}"
    path: "{{ project_source_path }}"
    state: link
  when: p.stat.isdir is defined and p.stat.isdir

- name: We should deploy to an empty folder
  file: path="{{ project_source_new_code_path }}" state=absent

- name: Clone project files to {{ project_source_new_code_path }}
  git:
    repo: "{{ project_git_repo }}"
    dest: "{{ project_source_new_code_path }}"
    version: "{{ project_git_version }}"
    force: true
    recursive: no

- name: Composer install Dashboard
  composer:
    command: install
    arguments: "--ansi --no-dev --no-interaction --optimize-autoloader --no-scripts"
    working_dir: "{{ project_source_new_code_path }}"
  environment:
        COMPOSER_DISCARD_CHANGES: "true"

- name: Ensuring required directories exist
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ project_source_new_code_path }}/application/config/{{ codeigniter_environment }}"

- name: Copying config files
  template:
    src: "{{ item }}"
    dest: "{{ project_source_new_code_path }}/application/config/{{ codeigniter_environment }}/{{ item | basename }}"
  with_fileglob:
    - ../templates/config/*.php

- name: Copying SAML config files
  template:
    src: "{{ item }}"
    dest: "{{ project_source_new_code_path }}/vendor/simplesamlphp/simplesamlphp/config/{{ item | basename }}"
  with_fileglob:
    - ../templates/saml/config/*.php

- name: Copying SAML metadata files
  template:
    src: "saml/metadata/{{ saml2_idp_entry }}/saml20-idp-remote.php"
    dest: "{{ project_source_new_code_path }}/vendor/simplesamlphp/simplesamlphp/metadata/saml20-idp-remote.php"

- name: Fixing SAML (removing nameIdPolicy)
  replace:
    dest: "{{ project_source_new_code_path }}/vendor/simplesamlphp/saml2/src/SAML2/AuthnRequest.php"
    regexp: '\$root->appendChild\(\$nameIdPolicy\);'
    replace: '//$root->appendChild($nameIdPolicy) ;'

- name: Fixing SAML (replacing saml2-acs.php)
  replace:
    dest: "{{ project_source_new_code_path }}/vendor/simplesamlphp/saml2/src/SAML2/HTTPPost.php"
    regexp: '\$msgStr = base64_encode\(\$msgStr\);'
    replace: '
      if (0 === stripos($_SERVER["REQUEST_URI"], "/dashboard")){
        $msgStr = str_replace(".gov/simple",".gov/dashboard/simple", $msgStr);
      }
      $msgStr = base64_encode(str_replace("simplesaml/module.php/saml/sp/saml2-acs.php/max","user/acs",$msgStr));'

#- name: Fixing SAML (allowing missing url)
#  replace:
#    dest: "{{ project_source_new_code_path }}/vendor/simplesamlphp/simplesamlphp/lib/SimpleSAML/Auth/State.php"
#    regexp: '\$allowMissing = FALSE'
#    replace: '$allowMissing = TRUE'

- name: Copying index.php
  template:
    src: "index.php"
    dest: "{{ project_source_new_code_path }}/index.php"

- name: Adding .env
  template:
    src: ".env"
    dest: "{{ project_source_new_code_path }}/.env"

- name: Symlink current dir with new code
  file:
    src: "{{ project_source_new_code_path }}"
    path: "{{ project_source_path }}"
    state: link

- name: Set up campaign status cfo-act datajson cron job to run @ 2300 nightly
  cron: 
    name: "campaign status cfo-act datajson cron job"
    minute: 0
    hour: 23
    job: "/usr/bin/php {{ project_source_path }}/index.php campaign status all all | tee /var/log/dashboard-cron.log | mail -s 'LabsData - Dashboard Cron Job - {{ real_ansible_env }}' -a 'From: datagov-bsp@gsa.gov' {{ cron_to_emails }}"
  run_once: true
